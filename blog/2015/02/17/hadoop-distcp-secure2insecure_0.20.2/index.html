<!doctype html><html class="no-js" lang="en"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>hadoop distcp from secure to insecure 0.20.2</title><link rel="stylesheet" type="text/css" href="https://mlciv.com/assets/css/styles_feeling_responsive.css" /> <script src="https://mlciv.com/assets/js/modernizr.min.js"></script> <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script> <script> if (location.protocol != 'https:'){ location.href = 'https:' + window.location.href.substring(window.location.protocol.length); } WebFont.load({ google: { families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ] } }); </script> <script language="JavaScript" type="text/javascript"> function toggleDiv(element){ if(document.getElementById(element).style.display == 'none') document.getElementById(element).style.display = 'block'; else document.getElementById(element).style.display = 'none'; } </script> <noscript><link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic|Volkhov' rel='stylesheet' type='text/css' /> </noscript><meta name="description" content="Keep a student mindset, and learn for/with/from machines. -- machine learning civilization" /><link rel="icon" sizes="32x32" href="https://mlciv.com/assets/img/favicon-32x32.png" /><link rel="icon" sizes="192x192" href="https://mlciv.com/assets/img/touch-icon-192x192.png" /><link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://mlciv.com/assets/img/apple-touch-icon-180x180-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://mlciv.com/assets/img/apple-touch-icon-152x152-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://mlciv.com/assets/img/apple-touch-icon-144x144-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://mlciv.com/assets/img/apple-touch-icon-120x120-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://mlciv.com/assets/img/apple-touch-icon-114x114-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://mlciv.com/assets/img/apple-touch-icon-76x76-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://mlciv.com/assets/img/apple-touch-icon-72x72-precomposed.png" /><link rel="apple-touch-icon-precomposed" href="https://mlciv.com/assets/img/apple-touch-icon-precomposed.png" /><meta name="msapplication-TileImage" content="https://mlciv.com/assets/img/msapplication_tileimage.png" /><meta name="msapplication-TileColor" content="#fabb00" /> <meta property="og:locale" content="en_EN" /><meta property="og:title" content="hadoop distcp from secure to insecure 0.20.2" /><meta property="og:description" content="Keep a student mindset, and learn for/with/from machines. -- machine learning civilization" /><meta property="og:url" content="https://mlciv.com//blog/2015/02/17/hadoop-distcp-secure2insecure_0.20.2/" /><meta property="og:site_name" content="MLCIV" /><link type="text/plain" rel="author" href="https://mlciv.com/humans.txt" /><body id="top-of-page" class="post"><div id="navigation" class="sticky"><nav class="top-bar" role="navigation" data-topbar><ul class="title-area"><li class="name"><h1 class="show-for-small-only"><a href="https://mlciv.com" class="icon-tree"> MLCIV</a></h1><li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></ul><section class="top-bar-section"><ul class="right"></ul><ul class="left"><li><a href="https://mlciv.com/">Home</a><li class="divider"></ul></section></nav></div><div id="masthead-no-image-header"><div class="row"><div class="small-12 columns"> <a id="logo" href="https://mlciv.com" title="MLCIV – Machine Learning Civilization"> <img src="https://mlciv.com/assets/img/logo.png" alt="MLCIV – Machine Learning Civilization"> </a></div></div></div><div class="row t30"><div class="medium-8 columns medium-offset-2 end"><article itemscope itemtype="http://schema.org/Article"><header> <span itemprop="name"><h1>hadoop distcp from secure to insecure 0.20.2</h1></span></header><span itemprop="articleSection"><h1 id="background">Background</h1><p>When secure hadoop 0.20.2 want to access insecure hadoop 0.20.2, espeically for using distcp on hdfs, the job (distcp) will try to get token for both source and destination FileSystem. However, the insecure hadoop will return null token for disabled security option, which let secure hadoop client(DFSClient) throw NPE and job failed. Hence, we need to upgrade hadoop client code about getDelegationToken to work around this case. <h1 id="solution">Solution</h1><h2 id="step-1">Step 1</h2><p>For null token received in DFSClient#getDelegationToken, not print it with stringifyToken<pre>
  <code>
      // For insecure, result will be null, and throwing NPE by stringifyToken
      if(result != null){
        LOG.info("Created " + stringifyToken(result));
      }else{
        // for null token, handled by DistributedFileSystem for creating an dummy token.
        LOG.info("Created null token!");
      }
  </code>
  </pre><h2 id="step-2">Step 2</h2><p>For null token received in DistributedFileSystem#getDelegationToken, return a new dummy Token> <code> result = new Token<DelegationTokenIdentifier>(identifier,password,kind,service); <code> &lt;/pre&gt; ## Step 3 Build new hadoop-core and deploy<pre>
      1. ant
      2. scp build/hadoop-core-0.20.2-cdh3u1.jar xxxx@xxxxx:/yourpath/
   </pre>## Step 4 Set CLASSPATH using this new hadoop client jar. 1. Only local support, let hadoop search HADOOP_CLASSPATH first for class loading.<pre>
       export HADOOP_CLASSPATH=/yourpath/hadoop-core-0.20.2-cdh3u1.jar
       export HADOOP_USER_CLASSPATH_FIRST=true
   </pre>2. For every node in secure cluster using this new jar. In most case, the job will get all required token, and set it into its Credential, which will make any other nodes in this cluster share this token. So usually there is no need for every node upgrades this new client, which will also pollute the secure cluster. Please add the following code into the code of your hadoop job:
