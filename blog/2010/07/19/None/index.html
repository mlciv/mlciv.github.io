<!doctype html><html class="no-js" lang="en"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>kernel module编写系统调用--关于sys_call_table</title><link rel="stylesheet" type="text/css" href="https://mlciv.com/assets/css/styles_feeling_responsive.css" /> <script src="https://mlciv.com/assets/js/modernizr.min.js"></script> <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script> <script> if (location.protocol != 'https:'){ location.href = 'https:' + window.location.href.substring(window.location.protocol.length); } WebFont.load({ google: { families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ] } }); </script> <script language="JavaScript" type="text/javascript"> function toggleDiv(element){ if(document.getElementById(element).style.display == 'none') document.getElementById(element).style.display = 'block'; else document.getElementById(element).style.display = 'none'; } </script> <noscript><link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic|Volkhov' rel='stylesheet' type='text/css' /> </noscript><meta name="description" content="Keep a student mindset, and actively learn the next thing for/with/from machines." /><link rel="icon" sizes="32x32" href="https://mlciv.com/assets/img/favicon-32x32.png" /><link rel="icon" sizes="192x192" href="https://mlciv.com/assets/img/touch-icon-192x192.png" /><link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://mlciv.com/assets/img/apple-touch-icon-180x180-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://mlciv.com/assets/img/apple-touch-icon-152x152-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://mlciv.com/assets/img/apple-touch-icon-144x144-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://mlciv.com/assets/img/apple-touch-icon-120x120-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://mlciv.com/assets/img/apple-touch-icon-114x114-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://mlciv.com/assets/img/apple-touch-icon-76x76-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://mlciv.com/assets/img/apple-touch-icon-72x72-precomposed.png" /><link rel="apple-touch-icon-precomposed" href="https://mlciv.com/assets/img/apple-touch-icon-precomposed.png" /><meta name="msapplication-TileImage" content="https://mlciv.com/assets/img/msapplication_tileimage.png" /><meta name="msapplication-TileColor" content="#fabb00" /> <meta property="og:locale" content="en_EN" /><meta property="og:title" content="kernel module编写系统调用--关于sys_call_table" /><meta property="og:description" content="Keep a student mindset, and actively learn the next thing for/with/from machines." /><meta property="og:url" content="https://mlciv.com//blog/2010/07/19/None/" /><meta property="og:site_name" content="MLCIV" /><link type="text/plain" rel="author" href="https://mlciv.com/humans.txt" /><body id="top-of-page" class="post"><div id="navigation" class="sticky"><nav class="top-bar" role="navigation" data-topbar><ul class="title-area"><li class="name"><h1 class="show-for-small-only"><a href="https://mlciv.com" class="icon-tree"> MLCIV</a></h1><li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></ul><section class="top-bar-section"><ul class="right"></ul><ul class="left"><li><a href="https://mlciv.com/">Home</a><li class="divider"></ul></section></nav></div><div id="masthead-no-image-header"><div class="row"><div class="small-12 columns"> <a id="logo" href="https://mlciv.com" title="MLCIV – Machine Learning Civilization"> <img src="https://mlciv.com/assets/img/logo.png" alt="MLCIV – Machine Learning Civilization"> </a></div></div></div><div class="row t30"><div class="medium-8 columns medium-offset-2 end"><article itemscope itemtype="http://schema.org/Article"><header> <span itemprop="name"><h1>kernel module编写系统调用--关于sys_call_table</h1></span></header><span itemprop="articleSection"><p>以下为08年时本科的一篇sys_call_table相关的日志【从原ijiessie.appspot.com迁移过来的】，算是我接触内核的第一篇日志，当时看到同学每次修改代码都得重新编译内核进行调试，我则先以模块形式配合系统调用表进行调试，加快了内核调试过程，有些许得意，遂记下这篇日志如下:<p>最近做Linux内核编程的课程设计，借此机会记录一下自己遇到的问题和解决方案吧。 <br /> 我们知道sys_call_table保存的是系统的调用的函数地址，它的长度由系统调用的多少决定。 <br /> 而我们的做法是，sys.c中，添加我们的系统抵用函数，把它编译到内核中去。 <br /> 我们有印象，在unistd.h中，define了一个叫做NR_syscall常量，他就是这个数组的大小，既然这个数组储存的是函数的地址，我们可以想到如果可以将自己函数给某一个sys_call_table赋值，这样我们在用户程序中直接调用系统调用的话，就会转到我们的函数去执行了。对于这个内核态变量的修改，自然也只能是在内核态去做，即在内核模块编程中可以很简单的是实现。 <br /> 现在我们整理一下思路：<ul><li>1.在自己编写内核模块中，获得sys_call_table的地址，从而操作每一个系统调用的函数入口地址。<li>2.编写自己的函数<li>3.将原系统调用的地址保存在一个变量中，等到模块卸载的时候，恢复函数的地址。<li>4.将自己函数的地址，赋值给相应的sys_call_table数组相应系统调用号的单元。<li>5.在模块退出的函数部分，必须恢复原调用的函数地址。</ul><p>内核模块源代码如下：<pre>    
<code>  
#include &lt;linux/syscalls.h&gt;       
#include &lt;asm/uaccess.h&gt;       
#include &lt;asm/io.h&gt;       
#include &lt;asm/unistd.h&gt;       
#include &lt;linux/kernel.h&gt;       
#include &lt;linux/init.h&gt;       
#include &lt;linux/module.h&gt;       
MODULE_DESCRIPTION("My kernel module");       
MODULE_AUTHOR("Jiessie [(Jiessie@localhost.localdomain)](mailto:%28Jiessie@localhost.localdomain%29)");       
MODULE_LICENSE("$LICENSE$");       
static int (*anything_saved)(void);       
//注意asmlinkage，必须注明是堆栈传递参数的，不然会出错       
asmlinkage int sys_mynum(int num1,int num2)       
{       
	printk("sys_mynum: you have called me :)? And send me 2 num:%d,%d",num1,num2);       
	return num2;       
}       
static int test_init_module(void)       
{       
	extern long sys_call_table[];       
	anything_saved=(int(*)(void))(sys_call_table[325]);//替换，你最好选一个自己新添加的系统调用       
	sys_call_table[325]=(unsigned long)sys_mynum;       
	printk( KERN_DEBUG "Module test init\n" );       
	return 0;       
}       
static void test_exit_module(void)       
{       
	extern long sys_call_table[];       
	sys_call_table[325]=(unsigned long)anything_saved; //恢复系统调用       
	printk( KERN_DEBUG "Module test exit\n" );       
}       
module_init(test_init_module);       
module_exit(test_exit_module);       
</code>
</pre><p>但是，在编译之后，用insmod插入的时候，出现错误，提示有非法的符号，你可以用dmesg进行查看，你会发现提示sys_call_table是非法的字符，即你用的extern没有访问到sys_call_table,发现这个问题，上网查到，原来sys_call_table没有在2.4以后的版本中EXPORT,需要自己在一个叫做ksyms.h文件中，将其导出。 <br /> 具体查了一下，是一个在/usr/src/linux-2.6.23.1/arch/i386/kernel/i386-ksyms.c里面。 <br /> 好了，这样，你在上述文件中，加上<pre>
<code>       
extern long sys_call_table[];       
EXPORT_SYMBOL(sys_call_table);       
</code>
</pre><p>重新编译一次内核即可，这样在以后，如果发现自己的系统调用有错，或是想调试，不需要每次都去编译内核，直接插入前面的内核模块，即可实现内核系统调用的改变，从而方便的调试和修改了。 <br /> 如果你还在不停的编译内核，不妨试一试，在一次编译之前加上<pre>
<code>
extern long sys_call_table[];       
EXPORT_SYMBOL(sys_call_table);       
</code>
</pre><p>将sys_call_table导出，以后你改系统调用就很简单了，甚至你还可以其他的“安全实验”。 <br /> 当然，你可以让你重新编译别人的内核是不太可能的，所以，这样导出sys_call_table是没有实战价值的，你可以参考 <br /> <a href="http://www.gd-emb.org/detail/id-43615.html">http://www.gd-emb.org/detail/id-43615.html</a> <br /> <a href="http://www.hackhome.com/InfoView/Article_80923.html">http://www.hackhome.com/InfoView/Article_80923.html</a> <br /> 这两种是通过查找0x80中断的处理程序来获得sys_call_table的地址的。大家也可以试一试。 </span><div id="page-meta" class="t30"><p>   <time class="icon-calendar pr20" datetime="2010-07-19" itemprop="datePublished"> 2010-07-19</time> <span class="icon-archive pr20"> LINUX · ARCHITECTURE</span> <br /> <span class="pr20"><span class="icon-price-tag pr10"> sys_call_table</span> <span class="icon-price-tag pr10"> kernel module</span> </span><div id="post-nav" class="row"><div class="small-2 columns text-center"><a class="radius button small" href="https://mlciv.com/blog/archive/" title="Blog Archive">Archive</a></div><div class="small-5 columns text-right"><a class="button small radius next" href="https://mlciv.com/blog/2010/07/21/None/">Xenoprof 安装和使用 &raquo;</a></div></div></div><h3 id="comments" class="t60">Dialogue &amp; Discussion</h3><div id="disqus_thread"></div><script type="text/javascript"> /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */ var disqus_shortname = 'jcao'; var disqus_identifier = '/blog/2010/07/19/None/'; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></article></div></div><div id="up-to-top" class="row"><div class="small-12 columns" style="text-align: right;"> <a class="iconfont" href="#top-of-page">&#xf108;</a></div></div><footer id="footer-content" class="bg-grau"><div id="footer"><div class="row"><div class="medium-6 large-5 columns"><h5 class="shadow-black">About This Site</h5><p class="shadow-black"> Keep a student mindset, and actively learn the next thing for/with/from machines. <a href="https://mlciv.com/info/">More ›</a></div><div class="small-6 medium-3 large-3 large-offset-1 columns"><h5 class="shadow-black">Services</h5><ul class="no-bullet shadow-black"><li > <a href="" title=""></a><li > <a href="/contact/" title="Contact">Contact</a><li > <a href="/feed.xml" title="Subscribe to RSS Feed">RSS</a><li > <a href="/atom.xml" title="Subscribe to Atom Feed">Atom</a><li > <a href="/sitemap.xml" title="Sitemap for Google Webmaster Tools">sitemap.xml</a></ul></div><div class="small-6 medium-3 large-3 columns"><h5 class="shadow-black">Related Links</h5><ul class="no-bullet shadow-black"><li > <a href="" title=""></a><li class="mlnlp" > <a href="http://nlp.cs.utah.edu" target="_blank" title="Utah NLP Group">Utah NLP Group</a><li class="iSAT" > <a href="https://www.colorado.edu/research/ai-institute/" target="_blank" title="iSAT">iSAT</a><li class="CLEAR" > <a href="https://www.colorado.edu/lab/clear/" target="_blank" title="CLEAR">CLEAR</a></ul></div></div></div><div id="subfooter"><nav class="row"><section id="subfooter-left" class="b30 small-12 medium-6 columns credits"><p> <a href="http://phlow.de" alt="Theme created by Phlow"> Powered by Phlow</a></section><section id="subfooter-right" class="small-12 medium-6 columns social-icons"><ul class="inline-list"><li><a href="https://scholar.google.com/citations?user=McBrjX4AAAAJ&hl=en" target="_blank" class="icon-google-scholar" title=""></a><li><a href="https://www.semanticscholar.org/author/Jie-Cao/144089400" target="_blank" class="icon-semantic-scholar" title=""></a><li><a href="public/CV_Jie-Cao.pdf" target="_blank" class="icon-cv" title=""></a><li><a href="mailto:jiecao at colorado dot edu" target="_blank" class="icon-mail" title=""></a><li><a href="https://www.researchgate.net/profile/Jie-Cao-7" target="_blank" class="icon-researchgate" title=""></a><li><a href="https://dblp.org/pid/39/6191-10.html" target="_blank" class="icon-dblp" title=""></a><li><a href="https://orcid.org/0000-0001-8268-954X" target="_blank" class="icon-orcid" title=""></a></ul></section></nav></div></footer><script src="https://mlciv.com/assets/js/javascript.min.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-50404010-1', 'auto'); ga('set', 'anonymizeIp', true); ga('send', 'pageview'); </script>
