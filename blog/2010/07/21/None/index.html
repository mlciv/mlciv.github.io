<!doctype html><html class="no-js" lang="en"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Xenoprof 安装和使用</title><link rel="stylesheet" type="text/css" href="https://mlciv.com/assets/css/styles_feeling_responsive.css" /> <script src="https://mlciv.com/assets/js/modernizr.min.js"></script> <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script> <script> if (location.protocol != 'https:'){ location.href = 'https:' + window.location.href.substring(window.location.protocol.length); } WebFont.load({ google: { families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ] } }); </script> <script language="JavaScript" type="text/javascript"> function toggleDiv(element){ if(document.getElementById(element).style.display == 'none') document.getElementById(element).style.display = 'block'; else document.getElementById(element).style.display = 'none'; } </script> <noscript><link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic|Volkhov' rel='stylesheet' type='text/css' /> </noscript><meta name="description" content="Keep a student mindset, and actively learn the next thing for/with/from machines." /><link rel="icon" sizes="32x32" href="https://mlciv.com/assets/img/favicon-32x32.png" /><link rel="icon" sizes="192x192" href="https://mlciv.com/assets/img/touch-icon-192x192.png" /><link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://mlciv.com/assets/img/apple-touch-icon-180x180-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://mlciv.com/assets/img/apple-touch-icon-152x152-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://mlciv.com/assets/img/apple-touch-icon-144x144-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://mlciv.com/assets/img/apple-touch-icon-120x120-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://mlciv.com/assets/img/apple-touch-icon-114x114-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://mlciv.com/assets/img/apple-touch-icon-76x76-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://mlciv.com/assets/img/apple-touch-icon-72x72-precomposed.png" /><link rel="apple-touch-icon-precomposed" href="https://mlciv.com/assets/img/apple-touch-icon-precomposed.png" /><meta name="msapplication-TileImage" content="https://mlciv.com/assets/img/msapplication_tileimage.png" /><meta name="msapplication-TileColor" content="#fabb00" /> <meta property="og:locale" content="en_EN" /><meta property="og:title" content="Xenoprof 安装和使用" /><meta property="og:description" content="Keep a student mindset, and actively learn the next thing for/with/from machines." /><meta property="og:url" content="https://mlciv.com//blog/2010/07/21/None/" /><meta property="og:site_name" content="MLCIV" /><link type="text/plain" rel="author" href="https://mlciv.com/humans.txt" /><body id="top-of-page" class="post"><div id="navigation" class="sticky"><nav class="top-bar" role="navigation" data-topbar><ul class="title-area"><li class="name"><h1 class="show-for-small-only"><a href="https://mlciv.com" class="icon-tree"> MLCIV</a></h1><li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></ul><section class="top-bar-section"><ul class="right"></ul><ul class="left"><li><a href="https://mlciv.com/">Home</a><li class="divider"></ul></section></nav></div><div id="masthead-no-image-header"><div class="row"><div class="small-12 columns"> <a id="logo" href="https://mlciv.com" title="MLCIV – Machine Learning Civilization"> <img src="https://mlciv.com/assets/img/logo.png" alt="MLCIV – Machine Learning Civilization"> </a></div></div></div><div class="row t30"><div class="medium-8 columns medium-offset-2 end"><article itemscope itemtype="http://schema.org/Article"><header> <span itemprop="name"><h1>Xenoprof 安装和使用</h1></span></header><span itemprop="articleSection"><blockquote><p>关于Xenoprof的功能简介这里不详细介绍，可以查看<a href="http://xenoprof.sourceforge.net/">这里</a>，而其前身Oprofile的安装和使用可以看<a href="http://oprofile.sourceforge.net/news/">这里</a>。 <br /> 本文主要记录本人关于Xenoprof的安装和使用，以及在其中可能曾经遇到的问题。</blockquote><p><strong>Xenoprof的安装</strong> <br /> 前文已经介绍了Xen的源码编译和安装，如果在之前Xen的安装中没有考虑Oprofile的安装配置，则这里需要进行如下配置并做轻量级编译。<ol><li><p><strong>软件包下载</strong> <br /> Oprofile是一个用户级别的工具，Xenoprof已经被包括在Xen中，仅仅需要对在Oprofile的网站(<a href="http://Oprofile.sourceforge.net/"><em>http://Oprofile.sourceforge.net/</em></a>)上下载的Oprofile源代码包，并且在Xenoprof的网站上(<a href="http://xenoprof.sourceforge.net/"><em>http://xenoprof.sourceforge.net/</em></a>)下载对应的Patch。<li><p><strong>打Patch,安装Oprofile</strong> <br /> 打Patch的命令，网上可以找到很多，从<a href="http://blog.chinaunix.net/u2/68236/showart_686359.html">这里</a>可以得到比较实践性的理解。 <br /> 执行patch -p1 &lt; ../../oprofile-0.9.3-xen-r2.patch 注意p1和p0可以自行选择使用. <br /> 执行./configure –with-kernel-support命令进行编译前的配置(可能提示没有libertylibrary，需要yum installbinutils-devel，同时需要gcc-c++编译器)； 配置好以后，按照Oprofile的README文件中执行make | make install即可完成OProfile的安装。<li><p><strong>配置Xen，重新编译</strong> <br /> 如果你的Xen已经编译安装过啦，那么这时你就需要更改配置文件进行轻量级编译安装。 <br /> 在编译前，需要修改一下配置文件，进入Xen源代码目录使用命令makelinux-2.6-xen-config CONFIGMODE=menuconfig，进入图形界面后需要将instrumentationsupport中的OProfile选中(一共两个选项，选择第一个选项以及第一个选项下的子选项即可)，保存并退出，然后进行Xen的轻量级安装，具体的过程可以查看Xen的ReadMe文件：</ol><pre>
<code>    

# make linux-2.6-xen-build        
# make linux-2.6-xen-instal  
</code>
</pre><p><strong>Xenopof的使用</strong><p>** **Xen编译安装好后，重新启动进入新编好的内核，其详细用法可以详细参考Oprofile的使用例子<a href="http://oprofile.sourceforge.net/examples/"><em>http://oprofile.sourceforge.net/examples/</em></a> <br /> 这里从虚拟机的测试来说明他的用法，它的相关资料可以在<a href="http://www.xen.org/files/summit_3/xenoprof_tutorial.pdf">http://www.xen.org/files/summit_3/<strong>xenoprof_tutorial</strong>.pdf</a>找到. <br /> 虚拟化下oprofile的测试分为两种，一种是主动模式，一种是被动模式，对于半虚拟化建议使用主动模式方式，而被动模式仅在镜像无法自定义修改的情况下使用，并且实验证明主动模式对于测试xen或者内核的开发的测试所获得的信息比被动模式要多.Xenoprof会建立一个profile的session，在这个session里可以有选择性地对多个虚拟机进行profile，以获取内核或应用程序的性能信息。启动这个会话的过程尤为重要，执行顺序特别要按照tutorial中来。其实这两种方式在tutoria中其实已经写得非常清楚了，这里不浪费资源重复写。这里特别说一下执行顺序和相关问题:<ol><li><p><strong>环境检查</strong>。opcontrol –reset做安装检查，在dom0中一般都可以通过，domu中无法通过，则需要检查一下你的半虚拟化镜像的制作是否是在oprofile安装好之后。<li><p><strong>opcontrol –help 可以查看相关的帮助,</strong><li><p><strong>开始要分别在各个dom0和domu中做opcontrol –reset的操作</strong><li><p><strong>start-daemon的配置。 <br /> **dom0&gt; opcontrol –start-daemon –event=GLOBAL_POWER_EVENTS:1000000 <br /> –xen=/boot/xen-syms-3.0-unstable –vmlinux=/boot/vmlinux-syms-2.6.16.13-xen0 <br /> –active-domains=1,3 <br /> 如上所示，可以用opcontrol –help|more来查看一些需要配置的信息。最主要的是以下几个： <br /> **-e/event:监测的事件。</strong>比如我想去监测CPU不空闲的时候的比率。用CPU_CLK_UNHALTED(这个对不同的CPU是不一定相同的，还有硬件不支持的，只能用时钟中断的方式来监测,注意CPUHalted的理解： <br /> _ 无论什么时候，只要操作系统调用HALT指令，CPU就会进入一种称之为HALT（译注：处于停机指令周期状态，又称C1状态，下同）的状态。具体来讲，当CPU进入HALT状态时，它的时钟信号就会被切断关闭一段时间。就在时钟信号关闭期间，CPU芯片逻辑单元也会相应地停止工作，这样就达到了节能目的。与此同时，系统性能也会受到较大影响。不过，HALT指令通常在系统繁忙期间并不会被调用，所以，HALT的性能损失并不大。（<a href="http://bbs.ocer.net/thread-271444-2-1.html">http://bbs.ocer.net/thread-271444-2-1.html</a>） <br /> _–xen 指向xen的为压缩的镜像 <br /> –vmlinux/–no-vmlinux:指定未压缩的内核文件，这个我在之前的文章<a href="http://ijiessie.appspot.com/?p=43001">《Xen源码编译安装总结》</a>中提到过,在Xen编译过程中，同时还会生成一个未压缩的vmlinux文件在/lib/modules/2.6.18.8-xen/build，直接将其拷出来引用即可. <br /> –active-domains 则是指定将要评测的dom的ID，这个可用通过xm list命令查看得到.<li><p><strong>在会话start-daemon启动之后，先启动domu的 start，再启动dom0的start,会话结束时，却是先直接用dom0的stop关掉，然后再一次shutdown，这里频繁切换dom,可能觉得不方便，可以使用ssh/rsh执行远程命令的方式进行，可以尽可能的减少反应时间引起的误差.</strong><li><p>**Opreport的使用 <br /> **在测试结束后，需要用opreport进行分析，opreport的选项可以参考Oprofile的使用例子<a href="http://oprofile.sourceforge.net/examples/"><em>http://oprofile.sourceforge.net/examples/</em></a> <br /> opreport –help可以参看详细的用法和选项。通常我们在opreport中加入如下选项 <br /> opreport -a -g –symbols –image-path=/lib/modules/2.6.18.8-xen/kernel &gt;result <br /> 其中-a指accumulate，即累加的，他可以方便的看到这段时间内某个事件的总时间,以CPU_CLK_UNHALTED为例，测试中，我们采用计算密集型程序进行测试，理论团队CPU应该几乎没有HLATED的时间，总的抽样数和CPU总的CLK数几乎吻合。 <br /> -g，则表示会细化到某个模块源代码的某一行 <br /> -l/—symobols 只相关符号，如函数等 <br /> -p/—image-path表示相关模块的查找位置，通常我们选用/lib/modules文件夹下所用内核对应的模块，当然不同的需求可以按需指定。 <br /> 其余的命令不一一介绍，需要的话直接opreport –help就知道.</ol></span><div id="page-meta" class="t30"><p>   <time class="icon-calendar pr20" datetime="2010-07-21" itemprop="datePublished"> 2010-07-21</time> <span class="icon-archive pr20"> VIRTUALIZATION</span> <br /> <span class="pr20"><span class="icon-price-tag pr10"> Xenoprof</span> <span class="icon-price-tag pr10"> Oprofile</span> <span class="icon-price-tag pr10"> opcontrol</span> <span class="icon-price-tag pr10"> CPU_CLK_UNHALTED</span> <span class="icon-price-tag pr10"> xenoprof安装使用</span> </span><div id="post-nav" class="row"><div class="small-5 columns"><a class="button small radius prev" href="https://mlciv.com/blog/2010/07/19/None/">&laquo; kernel module编写系统调用--关于sys_call_table</a></div><div class="small-2 columns text-center"><a class="radius button small" href="https://mlciv.com/blog/archive/" title="Blog Archive">Archive</a></div><div class="small-5 columns text-right"><a class="button small radius next" href="https://mlciv.com/blog/2010/08/04/None/">XenMon工作机制 &raquo;</a></div></div></div><h3 id="comments" class="t60">Dialogue &amp; Discussion</h3><div id="disqus_thread"></div><script type="text/javascript"> /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */ var disqus_shortname = 'jcao'; var disqus_identifier = '/blog/2010/07/21/None/'; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></article></div></div><div id="up-to-top" class="row"><div class="small-12 columns" style="text-align: right;"> <a class="iconfont" href="#top-of-page">&#xf108;</a></div></div><footer id="footer-content" class="bg-grau"><div id="footer"><div class="row"><div class="medium-6 large-5 columns"><h5 class="shadow-black">About This Site</h5><p class="shadow-black"> Keep a student mindset, and actively learn the next thing for/with/from machines. <a href="https://mlciv.com/info/">More ›</a></div><div class="small-6 medium-3 large-3 large-offset-1 columns"><h5 class="shadow-black">Services</h5><ul class="no-bullet shadow-black"><li > <a href="" title=""></a><li > <a href="/contact/" title="Contact">Contact</a><li > <a href="/feed.xml" title="Subscribe to RSS Feed">RSS</a><li > <a href="/atom.xml" title="Subscribe to Atom Feed">Atom</a><li > <a href="/sitemap.xml" title="Sitemap for Google Webmaster Tools">sitemap.xml</a></ul></div><div class="small-6 medium-3 large-3 columns"><h5 class="shadow-black">Related Links</h5><ul class="no-bullet shadow-black"><li > <a href="" title=""></a><li class="mlnlp" > <a href="http://nlp.cs.utah.edu" target="_blank" title="Utah NLP Group">Utah NLP Group</a><li class="iSAT" > <a href="https://www.colorado.edu/research/ai-institute/" target="_blank" title="iSAT">iSAT</a><li class="CLEAR" > <a href="https://www.colorado.edu/lab/clear/" target="_blank" title="CLEAR">CLEAR</a></ul></div></div></div><div id="subfooter"><nav class="row"><section id="subfooter-left" class="b30 small-12 medium-6 columns credits"><p> <a href="http://phlow.de" alt="Theme created by Phlow"> Powered by Phlow</a></section><section id="subfooter-right" class="small-12 medium-6 columns social-icons"><ul class="inline-list"><li><a href="http://github.com/mlciv" target="_blank" class="icon-github" title=""></a><li><a href="http://twitter.com/mlciv_jc" target="_blank" class="icon-twitter" title=""></a><li><a href="https://www.linkedin.com/in/jiessie/" target="_blank" class="icon-linkedin" title=""></a><li><a href="https://scholar.google.com/citations?user=McBrjX4AAAAJ&hl=en" target="_blank" class="ai-google-scholar" title=""></a><li><a href="mailto:jiecao at colorado dot edu" target="_blank" class="icon-mail" title=""></a></ul></section></nav></div></footer><script src="https://mlciv.com/assets/js/javascript.min.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-50404010-1', 'auto'); ga('set', 'anonymizeIp', true); ga('send', 'pageview'); </script>
